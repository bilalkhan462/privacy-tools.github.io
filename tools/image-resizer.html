<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Resize images to specific dimensions locally in your browser with live preview. No uploads, privacy guaranteed.">
    <title>Image Resizer - PrivacyTools</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="../index.html" class="logo">
                    <i class="fas fa-lock"></i>
                    <span>PrivacyTools</span>
                </a>
                <div class="nav-links">
                    <a href="../index.html#image-tools" class="nav-link">Image Tools</a>
                    <a href="../index.html#pdf-tools" class="nav-link">PDF Tools</a>
                    <a href="../index.html#privacy" class="nav-link">Privacy</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="tool-header">
                <h1>Image Resizer <span class="beta-badge">Live Preview</span></h1>
                <p class="tool-description">
                    Resize images to specific dimensions while maintaining aspect ratio. <strong>Live preview updates as you change settings!</strong>
                </p>
                
                <div class="privacy-notice">
                    <i class="fas fa-shield-alt"></i>
                    <span>Your files are processed locally and never leave your browser</span>
                </div>
            </div>

            <div class="tool-container">
                <div class="upload-area" id="dropArea">
                    <div class="upload-content">
                        <i class="fas fa-expand-alt"></i>
                        <h3>Drop your images here</h3>
                        <p>or click to browse</p>
                        <p class="upload-formats">Supports: JPG, PNG, GIF, WebP (Max: 10MB per file for preview)</p>
                        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.gif,.webp" multiple>
                    </div>
                </div>

                <div class="preview-container hidden" id="previewContainer">
                    <div class="preview-header">
                        <h3>Live Preview</h3>
                        <button id="closePreview" class="btn btn-secondary btn-small">
                            <i class="fas fa-times"></i> Close Preview
                        </button>
                    </div>
                    
                    <div class="preview-content">
                        <div class="preview-sidebar">
                            <div class="preview-info">
                                <h4>Current Image</h4>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value" id="previewName">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Original Size:</span>
                                        <span class="info-value" id="previewOriginalSize">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Original Dimensions:</span>
                                        <span class="info-value" id="previewOriginalDimensions">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">New Dimensions:</span>
                                        <span class="info-value" id="previewNewDimensions">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">New Size:</span>
                                        <span class="info-value" id="previewNewSize">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Reduction:</span>
                                        <span class="info-value" id="previewReduction">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="preview-controls">
                                <div class="control-group">
                                    <label for="previewScale">Preview Scale:</label>
                                    <div class="slider-container">
                                        <input type="range" id="previewScale" min="10" max="100" value="50">
                                        <span id="previewScaleValue">50%</span>
                                    </div>
                                </div>
                                
                                <div class="toggle-buttons">
                                    <button id="toggleBeforeAfter" class="btn btn-secondary btn-small">
                                        <i class="fas fa-exchange-alt"></i> Before/After
                                    </button>
                                    <button id="toggleGrid" class="btn btn-secondary btn-small">
                                        <i class="fas fa-th"></i> Toggle Grid
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-main">
                            <div class="preview-wrapper">
                                <div class="image-comparison">
                                    <div class="image-container">
                                        <div class="image-original">
                                            <h4>Original</h4>
                                            <div class="image-frame" id="originalPreview">
                                                <div class="no-preview">
                                                    <i class="fas fa-image"></i>
                                                    <p>Original image will appear here</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="image-resized">
                                            <h4>Preview <span class="preview-badge">Live</span></h4>
                                            <div class="image-frame" id="resizedPreview">
                                                <div class="no-preview">
                                                    <i class="fas fa-sliders-h"></i>
                                                    <p>Resized preview will update here</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="comparison-slider">
                                        <input type="range" id="comparisonSlider" min="0" max="100" value="50">
                                        <div class="slider-label">
                                            <span>Original</span>
                                            <span>Resized</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label>Resize Mode:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="resizeMode" value="dimensions" checked>
                                Specific Dimensions
                            </label>
                            <label>
                                <input type="radio" name="resizeMode" value="percentage">
                                Percentage
                            </label>
                            <label>
                                <input type="radio" name="resizeMode" value="max">
                                Maximum Size
                            </label>
                        </div>
                    </div>

                    <div class="dimensions-control" id="dimensionsControl">
                        <div class="dimension-inputs">
                            <div class="dimension-input">
                                <label for="width">Width (px):</label>
                                <div class="input-with-buttons">
                                    <input type="number" id="width" min="10" max="5000" value="800">
                                    <div class="input-buttons">
                                        <button class="btn-dimension" data-action="decrease" data-target="width">-</button>
                                        <button class="btn-dimension" data-action="increase" data-target="width">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="dimension-input">
                                <label for="height">Height (px):</label>
                                <div class="input-with-buttons">
                                    <input type="number" id="height" min="10" max="5000" value="600">
                                    <div class="input-buttons">
                                        <button class="btn-dimension" data-action="decrease" data-target="height">-</button>
                                        <button class="btn-dimension" data-action="increase" data-target="height">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="dimension-actions">
                            <label class="checkbox-label">
                                <input type="checkbox" id="maintainAspect" checked>
                                Maintain Aspect Ratio
                            </label>
                            <button id="swapDimensions" class="btn btn-secondary btn-small">
                                <i class="fas fa-exchange-alt"></i> Swap
                            </button>
                        </div>
                    </div>

                    <div class="percentage-control hidden" id="percentageControl">
                        <div class="slider-container">
                            <input type="range" id="percentage" min="10" max="500" value="100">
                            <span id="percentageValue">100%</span>
                        </div>
                        <div class="percentage-presets">
                            <button class="btn-preset" data-percentage="25">25%</button>
                            <button class="btn-preset" data-percentage="50">50%</button>
                            <button class="btn-preset" data-percentage="75">75%</button>
                            <button class="btn-preset" data-percentage="100">100%</button>
                            <button class="btn-preset" data-percentage="150">150%</button>
                            <button class="btn-preset" data-percentage="200">200%</button>
                        </div>
                        <p class="control-help">Scale image by percentage</p>
                    </div>

                    <div class="max-control hidden" id="maxControl">
                        <div class="dimension-input">
                            <label for="maxDimension">Maximum Dimension (px):</label>
                            <div class="input-with-buttons">
                                <input type="number" id="maxDimension" min="100" max="5000" value="1200">
                                <div class="input-buttons">
                                    <button class="btn-dimension" data-action="decrease" data-target="maxDimension">-</button>
                                    <button class="btn-dimension" data-action="increase" data-target="maxDimension">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="preset-buttons">
                            <button class="btn-preset" data-preset="web">Web (1200px)</button>
                            <button class="btn-preset" data-preset="hd">HD (1920px)</button>
                            <button class="btn-preset" data-preset="social">Social (1080px)</button>
                            <button class="btn-preset" data-preset="thumbnail">Thumbnail (300px)</button>
                        </div>
                        <p class="control-help">Image will fit within this dimension</p>
                    </div>

                    <div class="output-controls">
                        <div class="control-group">
                            <label for="outputFormat">Output Format:</label>
                            <select id="outputFormat">
                                <option value="original">Keep Original</option>
                                <option value="jpg">JPG</option>
                                <option value="png">PNG</option>
                                <option value="webp">WebP</option>
                            </select>
                        </div>

                        <div class="control-group" id="qualityControl">
                            <label for="quality">Quality (JPG/WebP):</label>
                            <div class="slider-container">
                                <input type="range" id="quality" min="0.1" max="1" step="0.05" value="0.9">
                                <span id="qualityValue">90%</span>
                            </div>
                        </div>
                    </div>

                    <div class="preview-buttons">
                        <button id="updatePreviewBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-sync-alt"></i>
                            Update Preview
                        </button>
                        <button id="showAllPreviews" class="btn btn-secondary" disabled>
                            <i class="fas fa-images"></i>
                            Show All Previews
                        </button>
                    </div>

                    <div class="button-group">
                        <button id="resizeBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-expand-alt"></i>
                            Resize All Images
                        </button>
                        <button id="clearBtn" class="btn btn-secondary">
                            <i class="fas fa-trash"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="progress-container hidden" id="progressContainer">
                    <div class="progress-header">
                        <h3>Resizing Images...</h3>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="file-list" id="fileList">
                    <!-- Files will be added here dynamically -->
                </div>

                <div class="results hidden" id="results">
                    <h3>Resize Complete!</h3>
                    <div class="summary">
                        <div class="summary-item">
                            <span class="summary-label">Images Resized:</span>
                            <span class="summary-value" id="resizedCount">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Size Saved:</span>
                            <span class="summary-value" id="totalSaved">0 KB</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Average Reduction:</span>
                            <span class="summary-value" id="averageReduction">0%</span>
                        </div>
                    </div>
                    
                    <div class="results-actions">
                        <button id="downloadAllBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Download All Resized Images
                        </button>
                        <button id="viewResultsBtn" class="btn btn-secondary">
                            <i class="fas fa-chart-bar"></i>
                            View Detailed Results
                        </button>
                    </div>
                </div>

                <div class="error-container hidden" id="errorContainer">
                    <!-- Errors will be shown here -->
                </div>
            </div>

            <div class="info-box">
                <h3><i class="fas fa-lightbulb"></i> Live Preview Features</h3>
                <ul>
                    <li><strong>Real-time updates</strong> as you change dimensions</li>
                    <li><strong>Before/After comparison</strong> with slider</li>
                    <li><strong>Size estimation</strong> before processing</li>
                    <li><strong>Preset dimensions</strong> for common use cases</li>
                    <li><strong>Visual feedback</strong> on size reduction</li>
                </ul>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-lock"></i>
                    <span>PrivacyTools</span>
                </div>
                <p class="footer-tagline">Free, client-side image and PDF tools that respect your privacy.</p>
                <p class="copyright">© 2024 PrivacyTools. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <style>
        /* Additional styles for preview functionality */
        .beta-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .preview-badge {
            background: var(--success-color);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .preview-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--primary-color);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-light);
        }

        .preview-header h3 {
            margin: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .preview-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .preview-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .preview-info {
            background: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }

        .preview-info h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--gray-light);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.875rem;
        }

        .info-value {
            font-weight: 500;
            color: var(--primary-color);
            font-size: 0.875rem;
            text-align: right;
        }

        .preview-controls {
            background: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }

        .toggle-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .toggle-buttons .btn {
            flex: 1;
        }

        .preview-main {
            display: flex;
            flex-direction: column;
        }

        .preview-wrapper {
            flex: 1;
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-comparison {
            width: 100%;
            max-width: 800px;
        }

        .image-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .image-original, .image-resized {
            text-align: center;
        }

        .image-original h4, .image-resized h4 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .image-frame {
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            padding: 1rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-frame.with-grid {
            background-image: 
                linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .image-frame img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .no-preview {
            text-align: center;
            color: var(--gray);
        }

        .no-preview i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .no-preview p {
            margin: 0;
            font-size: 0.9rem;
        }

        .comparison-slider {
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
        }

        .comparison-slider input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .input-with-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-buttons input {
            flex: 1;
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .btn-dimension {
            width: 36px;
            height: 36px;
            border: 1px solid var(--gray-light);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-dimension:hover {
            background: var(--gray-light);
            border-color: var(--gray);
        }

        .dimension-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .percentage-presets, .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-preset {
            padding: 0.5rem 1rem;
            background: var(--gray-light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-preset:hover {
            background: var(--primary-color);
            color: white;
        }

        .output-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .preview-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .preview-buttons .btn {
            flex: 1;
        }

        /* Animation for preview updates */
        @keyframes highlightChange {
            0% { background-color: transparent; }
            50% { background-color: rgba(76, 201, 240, 0.2); }
            100% { background-color: transparent; }
        }

        .highlight-update {
            animation: highlightChange 1s ease;
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .preview-content {
                grid-template-columns: 1fr;
            }
            
            .output-controls {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .image-container {
                grid-template-columns: 1fr;
            }
            
            .preview-buttons {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // Image Resizer with Live Preview - Complete working implementation
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const resizeBtn = document.getElementById('resizeBtn');
            const clearBtn = document.getElementById('clearBtn');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const updatePreviewBtn = document.getElementById('updatePreviewBtn');
            const showAllPreviews = document.getElementById('showAllPreviews');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const results = document.getElementById('results');
            const resizedCount = document.getElementById('resizedCount');
            const totalSaved = document.getElementById('totalSaved');
            const averageReduction = document.getElementById('averageReduction');
            const errorContainer = document.getElementById('errorContainer');
            
            // Preview elements
            const previewContainer = document.getElementById('previewContainer');
            const closePreview = document.getElementById('closePreview');
            const previewName = document.getElementById('previewName');
            const previewOriginalSize = document.getElementById('previewOriginalSize');
            const previewOriginalDimensions = document.getElementById('previewOriginalDimensions');
            const previewNewDimensions = document.getElementById('previewNewDimensions');
            const previewNewSize = document.getElementById('previewNewSize');
            const previewReduction = document.getElementById('previewReduction');
            const previewScale = document.getElementById('previewScale');
            const previewScaleValue = document.getElementById('previewScaleValue');
            const toggleBeforeAfter = document.getElementById('toggleBeforeAfter');
            const toggleGrid = document.getElementById('toggleGrid');
            const originalPreview = document.getElementById('originalPreview');
            const resizedPreview = document.getElementById('resizedPreview');
            const comparisonSlider = document.getElementById('comparisonSlider');
            
            // Resize controls
            const resizeModes = document.querySelectorAll('input[name="resizeMode"]');
            const dimensionsControl = document.getElementById('dimensionsControl');
            const percentageControl = document.getElementById('percentageControl');
            const maxControl = document.getElementById('maxControl');
            const widthInput = document.getElementById('width');
            const heightInput = document.getElementById('height');
            const maintainAspect = document.getElementById('maintainAspect');
            const percentageSlider = document.getElementById('percentage');
            const percentageValue = document.getElementById('percentageValue');
            const maxDimensionInput = document.getElementById('maxDimension');
            const outputFormat = document.getElementById('outputFormat');
            const qualityControl = document.getElementById('qualityControl');
            const qualitySlider = document.getElementById('quality');
            const qualityValue = document.getElementById('qualityValue');
            const swapDimensions = document.getElementById('swapDimensions');

            // State
            let files = [];
            let resizedFiles = [];
            let totalOriginalSize = 0;
            let totalResizedSize = 0;
            let originalDimensions = {};
            let currentPreviewIndex = 0;
            let previewCanvas = null;
            let previewContext = null;
            let isBeforeAfterMode = false;
            let isGridVisible = false;

            // Initialize
            function init() {
                // Create preview canvas
                previewCanvas = document.createElement('canvas');
                previewContext = previewCanvas.getContext('2d');
                
                // Resize mode toggle
                resizeModes.forEach(radio => {
                    radio.addEventListener('change', handleResizeModeChange);
                });
                
                // Percentage slider update
                percentageSlider.addEventListener('input', handlePercentageChange);
                
                // Quality slider update
                qualitySlider.addEventListener('input', handleQualityChange);
                
                // Output format change
                outputFormat.addEventListener('change', handleFormatChange);
                
                // File input change
                fileInput.addEventListener('change', handleFileSelect);
                
                // Button listeners
                resizeBtn.addEventListener('click', resizeAllImages);
                clearBtn.addEventListener('click', clearAll);
                downloadAllBtn.addEventListener('click', downloadAll);
                updatePreviewBtn.addEventListener('click', updatePreview);
                showAllPreviews.addEventListener('click', showAllPreviewsHandler);
                closePreview.addEventListener('click', hidePreview);
                swapDimensions.addEventListener('click', swapDimensionsHandler);
                
                // Preview controls
                previewScale.addEventListener('input', handlePreviewScaleChange);
                toggleBeforeAfter.addEventListener('click', toggleBeforeAfterHandler);
                toggleGrid.addEventListener('click', toggleGridHandler);
                comparisonSlider.addEventListener('input', handleComparisonSliderChange);
                
                // Dimension inputs with live preview
                widthInput.addEventListener('input', debounce(handleDimensionChange, 300));
                heightInput.addEventListener('input', debounce(handleDimensionChange, 300));
                maxDimensionInput.addEventListener('input', debounce(handleDimensionChange, 300));
                maintainAspect.addEventListener('change', handleDimensionChange);
                
                // Preset buttons
                document.querySelectorAll('.btn-preset').forEach(btn => {
                    btn.addEventListener('click', handlePresetClick);
                });
                
                // Dimension adjustment buttons
                document.querySelectorAll('.btn-dimension').forEach(btn => {
                    btn.addEventListener('click', handleDimensionButtonClick);
                });
                
                // Drag and drop setup
                setupDragAndDrop();
                
                // Update initial values
                updatePercentageValue();
                updateQualityValue();
                handleFormatChange();
                updatePreviewScaleValue();
                
                // Initialize comparison slider
                setupComparisonSlider();
            }

            function handleResizeModeChange(e) {
                const mode = e.target.value;
                
                // Hide all controls
                dimensionsControl.classList.add('hidden');
                percentageControl.classList.add('hidden');
                maxControl.classList.add('hidden');
                
                // Show selected control
                if (mode === 'dimensions') {
                    dimensionsControl.classList.remove('hidden');
                } else if (mode === 'percentage') {
                    percentageControl.classList.remove('hidden');
                } else if (mode === 'max') {
                    maxControl.classList.remove('hidden');
                }
                
                // Update preview if we have an image
                if (files.length > 0 && currentPreviewIndex !== null) {
                    updatePreview();
                }
            }

            function handlePercentageChange() {
                updatePercentageValue();
                
                // Auto-update preview for percentage mode
                const mode = document.querySelector('input[name="resizeMode"]:checked').value;
                if (mode === 'percentage' && files.length > 0 && currentPreviewIndex !== null) {
                    updatePreview();
                }
            }

            function updatePercentageValue() {
                percentageValue.textContent = `${percentageSlider.value}%`;
            }

            function handleQualityChange() {
                updateQualityValue();
                
                // Auto-update preview when quality changes
                if (files.length > 0 && currentPreviewIndex !== null) {
                    updatePreview();
                }
            }

            function updateQualityValue() {
                qualityValue.textContent = `${Math.round(qualitySlider.value * 100)}%`;
            }

            function handleFormatChange() {
                const format = outputFormat.value;
                qualityControl.classList.toggle('hidden', format === 'png');
                
                // Auto-update preview when format changes
                if (files.length > 0 && currentPreviewIndex !== null) {
                    updatePreview();
                }
            }

            function handleDimensionChange() {
                // Auto-update preview for dimensions mode
                const mode = document.querySelector('input[name="resizeMode"]:checked').value;
                if (mode === 'dimensions' && files.length > 0 && currentPreviewIndex !== null) {
                    updatePreview();
                }
            }

            function swapDimensionsHandler() {
                const temp = widthInput.value;
                widthInput.value = heightInput.value;
                heightInput.value = temp;
                handleDimensionChange();
            }

            function handlePresetClick(e) {
                const btn = e.target;
                
                if (btn.dataset.percentage) {
                    // Percentage preset
                    const percentage = parseInt(btn.dataset.percentage);
                    percentageSlider.value = percentage;
                    updatePercentageValue();
                    
                    // Switch to percentage mode if not already
                    document.querySelector('input[value="percentage"]').checked = true;
                    handleResizeModeChange({ target: document.querySelector('input[value="percentage"]') });
                    
                    // Update preview
                    if (files.length > 0 && currentPreviewIndex !== null) {
                        updatePreview();
                    }
                } else if (btn.dataset.preset) {
                    // Dimension preset
                    const preset = btn.dataset.preset;
                    let value;
                    
                    switch (preset) {
                        case 'web': value = 1200; break;
                        case 'hd': value = 1920; break;
                        case 'social': value = 1080; break;
                        case 'thumbnail': value = 300; break;
                        default: value = 1200;
                    }
                    
                    maxDimensionInput.value = value;
                    
                    // Switch to max mode if not already
                    document.querySelector('input[value="max"]').checked = true;
                    handleResizeModeChange({ target: document.querySelector('input[value="max"]') });
                    
                    // Update preview
                    if (files.length > 0 && currentPreviewIndex !== null) {
                        updatePreview();
                    }
                }
            }

            function handleDimensionButtonClick(e) {
                const btn = e.target;
                const action = btn.dataset.action;
                const target = btn.dataset.target;
                const input = document.getElementById(target);
                
                if (input) {
                    let value = parseInt(input.value) || 0;
                    const step = action === 'increase' ? 10 : -10;
                    value = Math.max(parseInt(input.min) || 10, Math.min(parseInt(input.max) || 5000, value + step));
                    input.value = value;
                    
                    // Trigger change event
                    input.dispatchEvent(new Event('input'));
                }
            }

            function setupDragAndDrop() {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                // Highlight drop area when dragging over
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                // Handle dropped files
                dropArea.addEventListener('drop', handleDrop, false);
                
                // Click to browse
                dropArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                dropArea.classList.add('drag-over');
            }

            function unhighlight() {
                dropArea.classList.remove('drag-over');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const droppedFiles = dt.files;
                handleFileSelect({ target: { files: droppedFiles } });
            }

            async function handleFileSelect(e) {
                const selectedFiles = e.target.files;
                hideError();
                
                // Convert FileList to array
                const newFiles = Array.from(selectedFiles).filter(file => {
                    // Accept only image files
                    return file.type.match(/^image\/(jpeg|png|jpg|gif|webp)$/i);
                });
                
                if (newFiles.length === 0) {
                    showError('Please select only image files (JPG, PNG, GIF, WebP)');
                    return;
                }
                
                // Check file sizes for preview (smaller limit for preview)
                const oversizedFiles = [];
                newFiles.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        oversizedFiles.push(file.name);
                    }
                });
                
                if (oversizedFiles.length > 0) {
                    showError(`Some files exceed 10MB limit for live preview: ${oversizedFiles.join(', ')}\nYou can still resize them, but preview will be limited.`);
                    // Continue anyway, just warn
                }
                
                // Add files to list
                for (let i = 0; i < newFiles.length; i++) {
                    const file = newFiles[i];
                    const fileIndex = files.length;
                    files.push(file);
                    totalOriginalSize += file.size;
                    
                    // Get image dimensions
                    try {
                        const dimensions = await getImageDimensions(file);
                        originalDimensions[fileIndex] = dimensions;
                    } catch (error) {
                        console.error('Error getting dimensions:', error);
                        originalDimensions[fileIndex] = { width: 0, height: 0 };
                    }
                    
                    // Create file item
                    const fileItem = createFileItem(file, fileIndex);
                    fileList.appendChild(fileItem);
                    
                    // Add remove button listener
                    fileItem.querySelector('.btn-remove').addEventListener('click', () => {
                        removeFile(fileIndex);
                    });
                    
                    // Add preview button listener
                    fileItem.querySelector('.btn-preview')?.addEventListener('click', () => {
                        showPreview(fileIndex);
                    });
                }
                
                // If this is the first file, show preview automatically
                if (files.length === 1) {
                    showPreview(0);
                }
                
                updateUI();
            }

            function getImageDimensions(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        resolve({
                            width: img.width,
                            height: img.height,
                            aspectRatio: img.width / img.height
                        });
                    };
                    
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        reject(new Error('Failed to load image'));
                    };
                    
                    img.src = url;
                });
            }

            function createFileItem(file, index) {
                const dimensions = originalDimensions[index] || { width: 0, height: 0 };
                const dimensionsText = dimensions.width > 0 ? 
                    `${dimensions.width} × ${dimensions.height}` : 'Loading...';
                
                const div = document.createElement('div');
                div.className = 'file-item';
                div.dataset.index = index;
                div.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-file-image"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                        <div class="file-dimensions">${dimensionsText}</div>
                        <div class="file-status">Ready to resize</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-preview" data-index="${index}" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-remove" data-index="${index}" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                return div;
            }

            function removeFile(index) {
                // Remove from arrays
                const removedFile = files.splice(index, 1)[0];
                totalOriginalSize -= removedFile.size;
                delete originalDimensions[index];
                
                // Remove resized file if exists
                if (resizedFiles[index]) {
                    totalResizedSize -= resizedFiles[index].size;
                    resizedFiles.splice(index, 1);
                }
                
                // Remove from DOM
                const fileItem = document.querySelector(`[data-index="${index}"]`);
                if (fileItem) {
                    fileItem.remove();
                }
                
                // If we removed the previewed file, hide preview
                if (currentPreviewIndex === index) {
                    hidePreview();
                    currentPreviewIndex = null;
                }
                
                // Update indices for remaining items
                updateFileIndices();
                
                updateUI();
            }

            function updateFileIndices() {
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach((item, i) => {
                    item.dataset.index = i;
                    item.querySelectorAll('button').forEach(btn => {
                        btn.dataset.index = i;
                    });
                });
                
                // Update current preview index if needed
                if (currentPreviewIndex !== null && currentPreviewIndex >= files.length) {
                    currentPreviewIndex = files.length - 1;
                    if (currentPreviewIndex >= 0) {
                        showPreview(currentPreviewIndex);
                    } else {
                        hidePreview();
                    }
                }
            }

            function updateUI() {
                const hasFiles = files.length > 0;
                
                // Enable/disable buttons
                resizeBtn.disabled = !hasFiles;
                updatePreviewBtn.disabled = !hasFiles;
                showAllPreviews.disabled = !hasFiles;
                
                // Hide results if no files
                if (!hasFiles) {
                    results.classList.add('hidden');
                    resizedFiles = [];
                    totalResizedSize = 0;
                }
                
                // Clear file input value to allow selecting same file again
                fileInput.value = '';
            }

            function showPreview(index) {
                if (index < 0 || index >= files.length) return;
                
                currentPreviewIndex = index;
                const file = files[index];
                const dimensions = originalDimensions[index];
                
                // Update preview info
                previewName.textContent = file.name;
                previewOriginalSize.textContent = formatFileSize(file.size);
                previewOriginalDimensions.textContent = `${dimensions.width} × ${dimensions.height}`;
                
                // Show preview container
                previewContainer.classList.remove('hidden');
                
                // Load original image
                loadImagePreview(file, originalPreview, 'original');
                
                // Update preview with current settings
                updatePreview();
            }

            function hidePreview() {
                previewContainer.classList.add('hidden');
                currentPreviewIndex = null;
                
                // Clear previews
                originalPreview.innerHTML = `
                    <div class="no-preview">
                        <i class="fas fa-image"></i>
                        <p>Original image will appear here</p>
                    </div>
                `;
                resizedPreview.innerHTML = `
                    <div class="no-preview">
                        <i class="fas fa-sliders-h"></i>
                        <p>Resized preview will update here</p>
                    </div>
                `;
            }

            async function updatePreview() {
                if (currentPreviewIndex === null || currentPreviewIndex >= files.length) return;
                
                const file = files[currentPreviewIndex];
                const originalDim = originalDimensions[currentPreviewIndex];
                const resizeMode = document.querySelector('input[name="resizeMode"]:checked').value;
                const outputFormatValue = outputFormat.value;
                const quality = parseFloat(qualitySlider.value);
                const maintainAspectRatio = maintainAspect.checked;
                
                try {
                    // Calculate target dimensions
                    let targetWidth, targetHeight;
                    
                    switch (resizeMode) {
                        case 'dimensions':
                            targetWidth = parseInt(widthInput.value) || originalDim.width;
                            targetHeight = parseInt(heightInput.value) || originalDim.height;
                            break;
                            
                        case 'percentage':
                            const percentage = parseInt(percentageSlider.value) / 100;
                            targetWidth = Math.round(originalDim.width * percentage);
                            targetHeight = Math.round(originalDim.height * percentage);
                            break;
                            
                        case 'max':
                            const maxDim = parseInt(maxDimensionInput.value);
                            if (originalDim.width > originalDim.height) {
                                targetWidth = maxDim;
                                targetHeight = Math.round(originalDim.height * (maxDim / originalDim.width));
                            } else {
                                targetHeight = maxDim;
                                targetWidth = Math.round(originalDim.width * (maxDim / originalDim.height));
                            }
                            break;
                            
                        default:
                            targetWidth = originalDim.width;
                            targetHeight = originalDim.height;
                    }
                    
                    // Ensure minimum dimensions
                    targetWidth = Math.max(1, targetWidth);
                    targetHeight = Math.max(1, targetHeight);
                    
                    // Apply aspect ratio if needed
                    if (maintainAspectRatio && resizeMode === 'dimensions') {
                        const aspectRatio = originalDim.aspectRatio;
                        if (widthInput.value && !heightInput.value) {
                            targetHeight = Math.round(targetWidth / aspectRatio);
                        } else if (heightInput.value && !widthInput.value) {
                            targetWidth = Math.round(targetHeight * aspectRatio);
                        } else if (widthInput.value && heightInput.value) {
                            // Fit within dimensions while maintaining aspect ratio
                            const widthRatio = targetWidth / originalDim.width;
                            const heightRatio = targetHeight / originalDim.height;
                            const ratio = Math.min(widthRatio, heightRatio);
                            
                            targetWidth = Math.round(originalDim.width * ratio);
                            targetHeight = Math.round(originalDim.height * ratio);
                        }
                    }
                    
                    // Update dimension inputs to reflect calculated values
                    if (resizeMode === 'dimensions') {
                        widthInput.value = targetWidth;
                        heightInput.value = targetHeight;
                    }
                    
                    // Generate preview
                    const previewUrl = await generatePreview(
                        file, 
                        targetWidth, 
                        targetHeight, 
                        outputFormatValue,
                        quality
                    );
                    
                    // Update preview display
                    loadImagePreview(previewUrl, resizedPreview, 'resized', targetWidth, targetHeight);
                    
                    // Update preview info
                    previewNewDimensions.textContent = `${targetWidth} × ${targetHeight}`;
                    
                    // Estimate new file size
                    const sizeEstimate = await estimateFileSize(
                        file, 
                        targetWidth, 
                        targetHeight, 
                        outputFormatValue,
                        quality
                    );
                    
                    previewNewSize.textContent = formatFileSize(sizeEstimate);
                    
                    const reduction = ((file.size - sizeEstimate) / file.size * 100).toFixed(1);
                    previewReduction.textContent = sizeEstimate < file.size ? 
                        `↓ ${reduction}%` : `↑ ${Math.abs(reduction)}%`;
                    previewReduction.style.color = sizeEstimate < file.size ? 
                        '#4cc9f0' : '#f72585';
                    
                    // Highlight the update
                    resizedPreview.classList.add('highlight-update');
                    setTimeout(() => {
                        resizedPreview.classList.remove('highlight-update');
                    }, 1000);
                    
                } catch (error) {
                    console.error('Preview error:', error);
                    resizedPreview.innerHTML = `
                        <div class="no-preview">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error generating preview</p>
                        </div>
                    `;
                }
            }

            function generatePreview(file, width, height, format, quality) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        
                        // Set canvas size
                        previewCanvas.width = width;
                        previewCanvas.height = height;
                        
                        // Clear canvas
                        previewContext.clearRect(0, 0, width, height);
                        
                        // Draw white background for transparent images if converting to JPG
                        if (format === 'jpg' || (format === 'original' && file.type.includes('png'))) {
                            previewContext.fillStyle = '#FFFFFF';
                            previewContext.fillRect(0, 0, width, height);
                        }
                        
                        // Draw resized image
                        previewContext.drawImage(img, 0, 0, width, height);
                        
                        // Convert to data URL
                        const mimeType = format === 'original' ? file.type : `image/${format}`;
                        const dataUrl = previewCanvas.toDataURL(mimeType, quality);
                        
                        resolve(dataUrl);
                    };
                    
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        reject(new Error('Failed to load image'));
                    };
                    
                    img.src = url;
                });
            }

            function estimateFileSize(file, width, height, format, quality) {
                // Simple estimation based on dimensions and quality
                const originalPixels = originalDimensions[currentPreviewIndex].width * originalDimensions[currentPreviewIndex].height;
                const newPixels = width * height;
                const pixelRatio = newPixels / originalPixels;
                
                // Base size per pixel (very rough estimation)
                let bytesPerPixel;
                switch (format) {
                    case 'jpg': bytesPerPixel = 0.5 * quality; break;
                    case 'png': bytesPerPixel = 4; break; // PNG is larger
                    case 'webp': bytesPerPixel = 0.3 * quality; break;
                    default: bytesPerPixel = file.size / originalPixels;
                }
                
                return Math.round(newPixels * bytesPerPixel);
            }

            function loadImagePreview(src, container, type, width = 0, height = 0) {
                // Clear container
                container.innerHTML = '';
                
                if (typeof src === 'string' && src.startsWith('data:')) {
                    // Data URL
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = `${type} preview`;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '400px';
                    
                    if (width && height) {
                        img.title = `${width} × ${height} pixels`;
                    }
                    
                    container.appendChild(img);
                } else if (src instanceof File) {
                    // File object
                    const url = URL.createObjectURL(src);
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `${type} preview`;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '400px';
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                    };
                    
                    container.appendChild(img);
                }
                
                // Apply grid if enabled
                if (isGridVisible) {
                    container.classList.add('with-grid');
                } else {
                    container.classList.remove('with-grid');
                }
            }

            function handlePreviewScaleChange() {
                updatePreviewScaleValue();
                
                const scale = parseInt(previewScale.value) / 100;
                const images = document.querySelectorAll('.image-frame img');
                images.forEach(img => {
                    img.style.transform = `scale(${scale})`;
                });
            }

            function updatePreviewScaleValue() {
                previewScaleValue.textContent = `${previewScale.value}%`;
            }

            function toggleBeforeAfterHandler() {
                isBeforeAfterMode = !isBeforeAfterMode;
                const comparisonContainer = document.querySelector('.image-comparison');
                
                if (isBeforeAfterMode) {
                    comparisonContainer.style.display = 'block';
                    toggleBeforeAfter.innerHTML = '<i class="fas fa-times"></i> Exit Comparison';
                } else {
                    comparisonContainer.style.display = 'grid';
                    toggleBeforeAfter.innerHTML = '<i class="fas fa-exchange-alt"></i> Before/After';
                }
            }

            function toggleGridHandler() {
                isGridVisible = !isGridVisible;
                const frames = document.querySelectorAll('.image-frame');
                
                if (isGridVisible) {
                    frames.forEach(frame => frame.classList.add('with-grid'));
                    toggleGrid.innerHTML = '<i class="fas fa-th-large"></i> Hide Grid';
                } else {
                    frames.forEach(frame => frame.classList.remove('with-grid'));
                    toggleGrid.innerHTML = '<i class="fas fa-th"></i> Show Grid';
                }
            }

            function setupComparisonSlider() {
                const slider = comparisonSlider;
                const container = document.querySelector('.image-container');
                
                slider.addEventListener('input', function() {
                    const value = this.value;
                    container.style.gridTemplateColumns = `${value}% ${100 - value}%`;
                });
            }

            function handleComparisonSliderChange() {
                const value = comparisonSlider.value;
                const container = document.querySelector('.image-container');
                container.style.gridTemplateColumns = `${value}% ${100 - value}%`;
            }

            function showAllPreviewsHandler() {
                // Create modal with all previews
                const modal = document.createElement('div');
                modal.className = 'previews-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    z-index: 10000;
                    padding: 2rem;
                    overflow-y: auto;
                `;
                
                modal.innerHTML = `
                    <div class="modal-header">
                        <h3 style="color: white; margin: 0;">All Image Previews</h3>
                        <button class="close-modal" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="previews-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        ${files.map((file, index) => `
                            <div class="preview-item" style="background: white; border-radius: 8px; padding: 1rem;">
                                <h4 style="margin-top: 0;">${escapeHtml(file.name)}</h4>
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">
                                    ${formatFileSize(file.size)} • ${originalDimensions[index]?.width || 0} × ${originalDimensions[index]?.height || 0}
                                </div>
                                <div class="preview-image" data-index="${index}" style="height: 200px; background: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <button class="btn-preview-modal" data-index="${index}" style="width: 100%; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Preview Resize
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Load previews
                files.forEach((file, index) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        const container = modal.querySelector(`.preview-image[data-index="${index}"]`);
                        if (container) {
                            container.innerHTML = '';
                            const previewImg = document.createElement('img');
                            previewImg.src = url;
                            previewImg.style.maxWidth = '100%';
                            previewImg.style.maxHeight = '200px';
                            container.appendChild(previewImg);
                        }
                    };
                    
                    img.src = url;
                });
                
                // Event listeners
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.querySelectorAll('.btn-preview-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        modal.remove();
                        showPreview(index);
                        // Scroll to preview
                        previewContainer.scrollIntoView({ behavior: 'smooth' });
                    });
                });
                
                // Close on ESC
                document.addEventListener('keydown', function closeOnEsc(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', closeOnEsc);
                    }
                });
            }

            async function resizeAllImages() {
                if (files.length === 0) return;
                
                showProgress(0);
                resizedFiles = [];
                totalResizedSize = 0;
                
                const resizeMode = document.querySelector('input[name="resizeMode"]:checked').value;
                const outputFormatValue = outputFormat.value;
                const quality = parseFloat(qualitySlider.value);
                const maintainAspectRatio = maintainAspect.checked;
                
                const reductions = [];
                
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const originalDim = originalDimensions[i];
                        
                        // Update progress
                        const progress = (i / files.length) * 100;
                        showProgress(progress);
                        
                        // Calculate target dimensions
                        let targetWidth, targetHeight;
                        
                        switch (resizeMode) {
                            case 'dimensions':
                                targetWidth = parseInt(widthInput.value) || originalDim.width;
                                targetHeight = parseInt(heightInput.value) || originalDim.height;
                                break;
                                
                            case 'percentage':
                                const percentage = parseInt(percentageSlider.value) / 100;
                                targetWidth = Math.round(originalDim.width * percentage);
                                targetHeight = Math.round(originalDim.height * percentage);
                                break;
                                
                            case 'max':
                                const maxDim = parseInt(maxDimensionInput.value);
                                if (originalDim.width > originalDim.height) {
                                    targetWidth = maxDim;
                                    targetHeight = Math.round(originalDim.height * (maxDim / originalDim.width));
                                } else {
                                    targetHeight = maxDim;
                                    targetWidth = Math.round(originalDim.width * (maxDim / originalDim.height));
                                }
                                break;
                                
                            default:
                                targetWidth = originalDim.width;
                                targetHeight = originalDim.height;
                        }
                        
                        // Ensure minimum dimensions
                        targetWidth = Math.max(1, targetWidth);
                        targetHeight = Math.max(1, targetHeight);
                        
                        // Apply aspect ratio if needed
                        if (maintainAspectRatio && resizeMode === 'dimensions') {
                            const aspectRatio = originalDim.aspectRatio;
                            if (widthInput.value && !heightInput.value) {
                                targetHeight = Math.round(targetWidth / aspectRatio);
                            } else if (heightInput.value && !widthInput.value) {
                                targetWidth = Math.round(targetHeight * aspectRatio);
                            } else if (widthInput.value && heightInput.value) {
                                // Fit within dimensions while maintaining aspect ratio
                                const widthRatio = targetWidth / originalDim.width;
                                const heightRatio = targetHeight / originalDim.height;
                                const ratio = Math.min(widthRatio, heightRatio);
                                
                                targetWidth = Math.round(originalDim.width * ratio);
                                targetHeight = Math.round(originalDim.height * ratio);
                            }
                        }
                        
                        // Resize image
                        const resizedFile = await resizeImage(
                            file, 
                            targetWidth, 
                            targetHeight, 
                            maintainAspectRatio,
                            outputFormatValue,
                            quality
                        );
                        
                        // Update file item with resized size
                        updateFileItemStatus(i, resizedFile, targetWidth, targetHeight);
                        
                        // Store resized file
                        resizedFiles.push(resizedFile);
                        totalResizedSize += resizedFile.size;
                        
                        // Calculate reduction
                        const reduction = ((file.size - resizedFile.size) / file.size * 100);
                        reductions.push(reduction);
                    }
                    
                    // Show final progress
                    showProgress(100);
                    
                    // Calculate results
                    const totalSavedBytes = totalOriginalSize - totalResizedSize;
                    resizedCount.textContent = files.length;
                    totalSaved.textContent = formatFileSize(totalSavedBytes);
                    
                    const avgReduction = reductions.length > 0 ? 
                        (reductions.reduce((a, b) => a + b, 0) / reductions.length).toFixed(1) : 0;
                    averageReduction.textContent = `${avgReduction}%`;
                    
                    // Show results section
                    results.classList.remove('hidden');
                    
                    // Show success notification
                    showNotification(`${files.length} image(s) resized successfully!`, 'success');
                    
                } catch (error) {
                    console.error('Resize error:', error);
                    showError(`Error resizing images: ${error.message}`);
                } finally {
                    // Hide progress after a delay
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                    }, 1000);
                }
            }

            function resizeImage(file, width, height, maintainAspectRatio, outputFormat, quality) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        
                        // Calculate final dimensions
                        let finalWidth = width;
                        let finalHeight = height;
                        
                        if (maintainAspectRatio) {
                            const aspectRatio = img.width / img.height;
                            
                            if (width && !height) {
                                finalHeight = Math.round(width / aspectRatio);
                            } else if (height && !width) {
                                finalWidth = Math.round(height * aspectRatio);
                            } else if (width && height) {
                                // Fit within dimensions while maintaining aspect ratio
                                const widthRatio = width / img.width;
                                const heightRatio = height / img.height;
                                const ratio = Math.min(widthRatio, heightRatio);
                                
                                finalWidth = Math.round(img.width * ratio);
                                finalHeight = Math.round(img.height * ratio);
                            }
                        }
                        
                        // Ensure minimum dimensions
                        finalWidth = Math.max(1, finalWidth);
                        finalHeight = Math.max(1, finalHeight);
                        
                        // Create canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = finalWidth;
                        canvas.height = finalHeight;
                        
                        const ctx = canvas.getContext('2d');
                        
                        // Set white background for transparent images if converting to JPG
                        if (outputFormat === 'jpg' || (outputFormat === 'original' && file.type.includes('png'))) {
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                        
                        // Draw resized image
                        ctx.drawImage(img, 0, 0, finalWidth, finalHeight);
                        
                        // Determine output format
                        let mimeType;
                        if (outputFormat === 'original') {
                            mimeType = file.type;
                        } else {
                            mimeType = `image/${outputFormat}`;
                        }
                        
                        // Convert to blob
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                reject(new Error('Failed to create blob'));
                                return;
                            }
                            
                            // Create filename
                            const extension = outputFormat === 'original' ? 
                                getFileExtension(file.name) : outputFormat;
                            const newName = `${getFileNameWithoutExtension(file.name)}_${finalWidth}x${finalHeight}.${extension}`;
                            
                            const resizedFile = new File([blob], newName, { type: mimeType });
                            resolve(resizedFile);
                        }, mimeType, quality);
                    };
                    
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        reject(new Error('Failed to load image'));
                    };
                    
                    img.src = url;
                });
            }

            function updateFileItemStatus(index, resizedFile, newWidth, newHeight) {
                const fileItem = document.querySelector(`[data-index="${index}"]`);
                if (fileItem) {
                    const originalSize = files[index].size;
                    const resizedSize = resizedFile.size;
                    const saved = originalSize - resizedSize;
                    const percentage = originalSize > 0 ? 
                        ((saved / originalSize) * 100).toFixed(1) : 0;
                    
                    const originalDim = originalDimensions[index];
                    const dimensionsElement = fileItem.querySelector('.file-dimensions');
                    const statusElement = fileItem.querySelector('.file-status');
                    
                    if (dimensionsElement) {
                        dimensionsElement.textContent = 
                            `${originalDim.width}×${originalDim.height} → ${newWidth}×${newHeight}`;
                    }
                    
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div><strong>${formatFileSize(originalSize)} → ${formatFileSize(resizedSize)}</strong></div>
                            <div style="color: ${saved > 0 ? '#4cc9f0' : '#f72585'}; font-size: 0.875rem;">
                                ${saved > 0 ? '✓ Saved ' : 'Increased '}${formatFileSize(Math.abs(saved))} (${percentage}%)
                            </div>
                        `;
                    }
                }
            }

            function showProgress(percentage) {
                progressContainer.classList.remove('hidden');
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${Math.round(percentage)}%`;
            }

            function downloadAll() {
                if (resizedFiles.length === 0) return;
                
                resizedFiles.forEach((file, index) => {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                showNotification('Downloads started!', 'success');
            }

            function clearAll() {
                files = [];
                resizedFiles = [];
                totalOriginalSize = 0;
                totalResizedSize = 0;
                originalDimensions = {};
                currentPreviewIndex = null;
                
                fileList.innerHTML = '';
                results.classList.add('hidden');
                hidePreview();
                hideError();
                progressContainer.classList.add('hidden');
                
                updateUI();
            }

            function showError(message) {
                errorContainer.classList.remove('hidden');
                errorContainer.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${escapeHtml(message)}</span>
                `;
                
                // Auto-hide error after 5 seconds
                setTimeout(() => {
                    hideError();
                }, 5000);
            }

            function hideError() {
                errorContainer.classList.add('hidden');
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    background: ${type === 'success' ? '#4cc9f0' : '#f72585'};
                    color: white;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    z-index: 9999;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    animation: slideIn 0.3s ease;
                `;
                
                const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <span>${escapeHtml(message)}</span>
                    <button class="notification-close" style="background: none; border: none; color: inherit; margin-left: 10px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                if (!document.querySelector('#notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(notification);
                
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // Utility functions
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function getFileNameWithoutExtension(filename) {
                return filename.replace(/\.[^/.]+$/, "");
            }

            function getFileExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Initialize the resizer
            init();
        });
    </script>
</body>
</html>.